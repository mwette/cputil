#!/bin/sh
#
# mindist: create minimum distribution for running cputil
#
# Copyright (C) 2016,2021 Matthew R. Wette
# 
# Copying and distribution of this file, with or without modification,
# are permitted in any medium without royalty provided the copyright
# notice and this notice are preserved.  This file is offered as-is,
# without any warranty.

prefix=@prefix@
srcdist=..

if [ $# -ne 1 ]; then
  echo "usage: mindist <destdir>"
  exit 1
fi
destdir=$1

top=$destdir/$prefix
exe=$exe

rm -f $top/bin/callgrind*
rm -f $top/bin/cg_*
rm -f $top/bin/ms_print
rm -f $top/bin/valgrind-di-server
rm -f $top/bin/valgrind-listener
rm -f $top/bin/vgdb
#rm -rf $top/libexec
if [ -f $top/bin/valgrind ]; then
  mv $top/bin/valgrind $exe/valgrind
fi
#
if [ -f $top/include/valgrind/libvex_ir.h ]; then
  cp $top/include/valgrind/libvex_ir.h $exe/
fi
if [ -f $top/include/valgrind/cputil.h ]; then
   mv $top/include/valgrind/cputil.h $top/
fi
rm -rf $top/include
mkdir -p $top/include
if [ -f $top/cputil.h ]; then
  mv $top/cputil.h $top/include/
fi
rm -rf $top/share
rm -rf $top/lib/pkgconfig
#
rm -rf $exe/vgpreload_memcheck*
rm -rf $exe/vgpreload_massif*
rm -rf $exe/vgpreload_exp*
rm -rf $exe/vgpreload_drd*
rm -rf $exe/vgpreload_helgrind*
#
rm  -f $exe/s390*
rm  -f $exe/power*
rm  -f $exe/mips*
rm  -f $exe/arm*
#
rm -rf $exe/none*
rm -rf $exe/memcheck*
rm -rf $exe/massif*
rm -rf $exe/getoff*
rm -rf $exe/helgrind*
rm -rf $exe/lackey*
rm -rf $exe/exp*
rm -rf $exe/drd*
rm -rf $exe/cachegrind*
rm -rf $exe/callgrind*
#
rm  -f $exe/*.xml
rm  -f $exe/*.a
rm  -f $exe/default.supp
#

echo "#!/bin/sh" >$top/bin/cputil
echo "VALGRIND_LIB=$pkglibdir" >>$top/bin/cputil
echo "#export VALGRIND_LIB" >>$top/bin/cputil
echo "\$VALGRIND_LIB/valgrind -q" '--tool=cputil "$@"' >>$top/bin/cputil
chmod +x $top/bin/cputil

# --- last line of mindist ---
